# Каталог автомобилей - Документация проекта

## Обзор проекта

Это приложение каталога автомобилей, построенное на современном стеке технологий. Система предоставляет функциональность для просмотра, фильтрации и детального изучения автомобилей с возможностью добавления в избранное и расчета кредитных платежей.

### Основные технологии

- **Frontend Framework**: React 18.3.1 с TypeScript
- **Build Tool**: Vite 7.1.2
- **Styling**: Tailwind CSS + CSS-модули
- **UI Components**: Radix UI (полный набор компонентов)
- **State Management**: React Query (TanStack Query) + React Hooks
- **Routing**: React Router DOM 6.30.1
- **Backend Integration**: REST API с кэшированием
- **Deployment**: Netlify с функциями

## Структура проекта

```
project/
├── client/                          # Основное клиентское приложение
│   ├── components/ui/               # UI компоненты (Radix UI wrappers)
│   ├── src/                        # Исходный код приложения
│   │   ├── components/             # Компоненты по atomic design
│   │   │   ├── atoms/              # Базовые UI элементы
│   │   │   ├── molecules/          # Составные компоненты
│   │   │   ├── organisms/          # Сложные компоненты
│   │   │   └── templates/          # Шаблоны страниц
│   │   ├── hooks/                  # Кастомные React хуки
│   │   ├── lib/                    # Утилиты и API
│   │   ├── pages/                  # Страницы приложения
│   │   ├── styles/                 # Стили и CSS токены
│   │   └── types/                  # TypeScript типы
│   ├── App.tsx                     # Корневой компонент приложения
│   └── pages/                      # Дополнительные страницы
├── server/                         # Серверная логика
├── shared/                         # Общий код между клиентом и сервером
├─ netlify/                        # Конфигурация и функции Netlify
└── конфигурационные файлы
```

---

## Детальное описание файлов и компонентов

### Корневые файлы конфигурации

#### `package.json`
Основной файл конфигурации npm со всеми зависимостями проекта. Содержит:
- **Скрипты сборки**: `build:client`, `build:server`, `dev`
- **Основные зависимости**: Express, Zod для валидации, dotenv
- **Dev зависимости**: Полный стек Radix UI, React Query, TypeScript, Vite
- **Специальные зависимости**: `embla-carousel-react` для карусели фото, `framer-motion` для анимаций

#### `vite.config.ts`
Конфигурация Vite для разработки и сборки:
- **Сервер разработки**: Порт 8080, host "::" для доступа извне
- **Алиасы путей**: `@` для `./client`, `@shared` для `./shared`
- **Express Plugin**: Интегрирует Express сервер в dev режиме
- **Файловая система**: Ограничивает доступ к определенным папкам для безопасности

#### `netlify.toml`
Конфигурация развертывания Netlify:
- **Build команда**: `npm run build:client`
- **Publish директория**: `dist/spa`
- **Функции**: Размещены в `netlify/functions`
- **Редиректы**: Все `/api/*` запросы направляются на Netlify функции

### Основное приложение

#### `client/App.tsx`
Корневой компонент всего приложения, который настраивает:
- **QueryClient**: Конфигурация React Query с настройками кэширования (5 мин staleTime, 10 мин gcTime)
- **Роутинг**: React Router с маршрутами:
  - `/` → редирект на `/catalog`
  - `/catalog` → страница каталога
  - `/car/:id` → детальная страница автомобиля
  - `*` → страница 404
- **Providers**: TooltipProvider, Toaster, Sonner для уведомлений

### Страницы приложения

#### `client/src/pages/CatalogPage.tsx`
Главная страница каталога автомобилей с полной функциональностью:

**Основные возможности:**
- **Фильтрация**: Иерархические фильтры (марка → модель → поколение → тип)
- **Сортировка**: По дате, цене, пробегу (ascending/descending)
- **Пагинация**: Постраничный просмотр результатов
- **Избранное**: Добавление/удаление автомобилей из избранного
- **Responsive**: Мобильная версия с модальными фильтрами

**Состояние и логика:**
- `appliedFilters` и `pendingFilters` для управления состоянием фильтров
- Синхронизация с URL параметрами через `useSearchParams`
- Восстановление позиции скролла при возврате с детальной страницы
- Разное поведение открытия ссылок на мобильных/десктопных устройствах

**Компоненты:**
- `Header`, `Footer` - навигация и подвал
- `FiltersAside` - боковая панель фильтров
- `CarGrid` - сетка карточек автомобилей
- `FloatingFavoritesButton` - плавающая кнопка избранного

#### `client/src/pages/CarDetailPage.tsx`
Детальная страница автомобиля с расширенной функциональностью:

**Основные секции:**
1. **CarTitleSection**: Название, цена с поповером для расчета, кнопка избранного
2. **PhotoSection**: Карусель основных фото + сетка миниатюр + лайтбокс
3. **InterestSection**: Форма обратной связи с валидацией
4. **SpecificationsSection**: Вкладки с характеристиками и информацией о ДТП  
5. **HorizontalCreditCalculator**: Интерактивный калькулятор кредита
6. **DeliverySection**: Информация о доставке
7. **LocationSection**: Контакты дилера и карта
8. **RelatedCarsSection**: Похожие автомобили

**Специальные возможности:**
- **Embla Carousel**: Профессиональная карусель для фото с навигацией
- **Лайтбокс**: Полноэкранный просмотр фотографий
- **Price Calculation Popover**: Детальный расчет цены при клике
- **Responsive Design**: Адаптивная сетка для мобильных устройств

### Хуки (Hooks)

#### `client/src/hooks/useHierarchicalFilters.ts`
Ключевой хук для управления иерархическими фильтрами:

**Функциональность:**
- **Кэширование**: Сохраняет данные фильтров в localStorage на 24 часа
- **Синхронные функции**: `getModelsForBrand`, `getGenerationsForModel`, `getTypesForGeneration`
- **Плоские списки**: Готовые опции для UI (`brandOptions`, `fuelOptions`, `colorOptions`)
- **Состояния загрузки**: `isLoading`, `error` для UI feedback

**Логика работы:**
1. При монтировании проверяет кэш в localStorage
2. Если кэш валиден (не старше 24 часов) - использует его
3. Иначе загружает данные с API `/filters`
4. Сохраняет новые данные в кэш
5. Предоставляет синхронные функции для получения зависимых спискок

#### `client/src/hooks/useCars.ts`
Хук для загрузки данных автомобилей с использованием React Query:
- Интеграция с `getCatalog` API
- Кэширование ответов на 5 минут
- Автоматическое обновление при изменении фильтров
- Обработка состояний загрузки и ошибок

#### `client/src/hooks/useFavorites.ts`
Управление списком избранных автомобилей:
- Сохранение в localStorage
- Функции добавления/удаления/переключения
- Получение полных данных избранных авто
- Синхронизация состояния между компонентами

### API и утилиты

#### `client/src/lib/api.ts`
Центральный модуль для всех API запросов с продвинутой функциональностью:

**Основные функции:**
- `getCatalog(params)` - получение списка автомобилей с фильтрами
- `getCar(id)` - получение детальной информации об автомобиле
- `getHierarchicalFilters()` - получение структуры фильтров с кэшированием

**Кэширование фильтров:**
```typescript
const CACHE_KEY = 'car_filters_cache';
const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 часа

function getCachedFilters(): RawFiltersData | null
function setCachedFilters(data: RawFiltersData): void
```

**Обработка ошибок:**
- Retry логика с экспоненциальным backoff
- Timeout 15 секунд с отдельной обработкой
- Детальное логирование для диагностики
- Fallback механизмы для различных типов ошибок

**Типы данных:**
- `CatalogParams` - параметры запроса каталога
- `ApiCar` - модель автомобиля от API
- `RawFiltersData` - иерархическая структура фильтров

#### `client/src/lib/apiTransforms.ts`
Трансформация данных между API и внутренними типами:
- `transformApiCarToCar()` - конвертация API модели в UI модель
- `transformUrlParamsToFilters()` - парсинг URL параметров в объект фильтров
- `transformFiltersToUrlParams()` - обратная конвертация для URL
- `resetDependentFilters()` - сброс зависимых фильтров при изменении родительских

#### `client/src/lib/utils.ts`
Набор утилитарных функций для всего приложения:
- `cn()` - объединение CSS классов через clsx и tailwind-merge
- `formatPrice()`, `formatMileage()` - форматирование числовых значений
- `calculateMonthlyPayment()` - расчет ежемесячного платежа
- `debounce()` - задержка выполнения функций
- `getStatusVariant()` - получение CSS классов для статусов
- Валидация email и телефона
- Работа с localStorage с обработкой ошибок

#### `client/src/lib/constants.ts`
Константы для фильтров:
- `FUEL_TYPES` - типы топлива с русскими названиями
- `BODY_COLORS` - цвета кузова (основные + расширенные)
- TypeScript типы `FuelType`, `BodyColor`

#### `client/src/lib/photoUtils.ts`
Утилиты для работы с фотографиями:
- `filterAndSortDetailPhotos()` - фильтрация и сортировка фото для детальной страницы
- Логика приоритетности фото (001, 003, 004, 007)
- Fallback на альтернативные источники фото

### Компоненты

#### Атомы (Atoms) - `client/src/components/atoms/`

**Button (`Button.tsx`)**
Универсальная кнопка с вариантами:
- Варианты: `primary`, `secondary`, `outline`, `ghost`
- Размеры: `sm`, `md`, `lg`, `icon`
- Состояния: `disabled`, `loading` со спиннером
- Поддержка иконок и различных типов (`button`, `submit`, `reset`)

**Icon (`Icon.tsx`)**
Компонент иконок на основе Lucide React:
- Размеры: `sm`, `md`, `lg`
- Настройка цвета и className
- Автоматический fallback если иконка не найдена

**Badge (`Badge.tsx`)**
Бейджи для статусов автомобилей:
- Варианты для разных статусов (`rate-3-5`, `rate-5-plus`, `rate-0-3`)
- Цветовая схема соответствует статусам растаможки

**Input (`Input.tsx`)**
Поле ввода с валидацией:
- Типы: `text`, `number`, `email`, `tel`
- Состояния ошибок с красной подсветкой
- Поддержка placeholder и автофокуса

**Skeleton (`Skeleton.tsx`)**
Заглушки для загружающегося контента:
- Анимированные серые блоки
- Настраиваемые размеры через className

#### Молекулы (Molecules) - `client/src/components/molecules/`

**Select (`Select.tsx`)**
Продвинутый компонент выбора:
- **Мультиселект**: Поддержка множественного выбора
- **Поиск**: Фильтрация опций по тексту
- **Состояния**: disabled, loading, error
- **Клавиатурная навигация**: стрелки, Enter, Escape
- **Виртуализация**: для больших списков опций

**PriceRange (`PriceRange.tsx`)**
Компонент выбора диапазона цен:
- Два input поля "От" и "До"
- Автоматическое форматирование чисел
- Валидация корректности диапазона

**YearMonthRange (`YearMonthRange.tsx`)**
Выбор диапазона года и месяца выпуска:
- Связанные селекты года и месяца
- Логика сброса месяца при сбросе года
- Валидация корректности периода

**MileageRange (`MileageRange.tsx`)**
Выбор диапазона пробега:
- Поля "От" и "До" с форматированием км
- Ограничения по минимальным/максимальным значениям

**Pagination (`Pagination.tsx`)**
Пагинация для каталога:
- Номера страниц с многоточиями для больших списков
- Кнопки "Предыдущая"/"Следующая"
- Отключение при загрузке

**SortSelect (`SortSelect.tsx`)**
Выбор сортировки:
- Опции: по дате, цене, пробегу (по возрастанию/убыванию)
- Интеграция с URL параметрами

**PriceCalculationPopover (`PriceCalculationPopover.tsx`)**
Поповер для детального расчета цены:
- **Модальное окно**: Появляется при клике на цену
- **Расчеты**: Базовая стоимость, таможенные сборы, итоговая цена
- **Курсы валют**: Актуальная информация о курсах
- **Закрытие**: По клику вне области или на крестик

#### Организмы (Organisms) - `client/src/components/organisms/`

**Header (`Header.tsx`)**
Главная навигация сайта:
- **Логотип**: Ссылка на главную страницу
- **Меню навигации**: Каталог, Наш подход, Опции, О компании, Контакты
- **Социальные сети**: YouTube, WhatsApp, Telegram
- **Контактная информация**: Номер телефона
- **Responsive**: Адаптивное меню для мобильных устройств

**Footer (`Footer.tsx`)**
Подвал сайта с дополнительной информацией и ссылками

**FiltersAside (`FiltersAside.tsx`)**
Боковая панель фильтров с полной функциональностью:

**Структура фильтров:**
1. **Автомобиль**: Иерархические фильтры (Марка → Модель → Поколение → Комплектация)
2. **Цена**: Диапазон цен с полями "От" и "До"
3. **Год выпуска**: Год + месяц выпуска
4. **Пробег**: Диапазон пробега
5. **Двигатель**: Тип топлива (мультиселект)
6. **Цвет кузова**: Цвета (мультиселект)
7. **Состояние**: Чекбокс "Без повреждений"

**Особенности:**
- **Зависимые списки**: Автоматическое обновление дочерних фильтров
- **Сброс групп**: Кнопка "Сбросить" для каждой группы фильтров
- **Липкая панель действий**: Кнопки "сбросить все"/"Показать" остаются видимыми
- **Skeleton loading**: Анимированные заглушки во время загрузки
- **Обработка ошибок**: Показ ошибок с предложением перезагрузки

**CarGrid (`CarGrid.tsx`)**
Сетка карточек автомобилей:
- **Responsive grid**: 1-4 колонки в зависимости от размера экрана
- **Состояния загрузки**: Skeleton карточки
- **Обработка ошибок**: Сообщения об ошибках с кнопкой повтора
- **Пустое состояние**: Сообщение когда нет результатов

**CarCard (`CarCard.tsx`)**
Карточка автомобиля в каталоге:
- **Фото**: Основное изображение с fallback
- **Информация**: Название, год, пробег, расположение
- **Цена**: С расчетом ежемесячного платежа
- **Статус**: Бейдж с информацией о растаможке
- **Избранное**: Кнопка добавления в избранное
- **Hover эффекты**: Анимации при наведении

**CarSummary (`CarSummary.tsx`)**
Краткая сводка об автомобиле на детальной странице:
- Основные характеристики в удобном формате
- Интеграция с другими компонентами страницы

#### UI Компоненты - `client/components/ui/`

Папка содержит обертки над компонентами Radix UI, настроенные под дизайн-систему проекта. Включает стандартный набор: `accordion`, `alert-dialog`, `button`, `dialog`, `dropdown-menu`, `popover`, `select`, `toast` и множество других компонентов. Все компоненты стилизованы с помощью Tailwind CSS и поддерживают темизацию.

### Типы TypeScript

#### `client/src/types/index.ts`
Центральный файл с типами для всего приложения:

**Основные интерфейсы:**
- `Car` - модель автомобиля для UI
- `Filters` - объект фильтров каталога
- `ApiCar` - модель автомобиля от API
- `SortOption` - типы сортировки
- `FilterOption` - опция для селектов

**Специальные типы:**
- `StatusType` - типы статусов растаможки
- `SearchParams` - параметры URL
- `FavoritesState` - состояние избранного

### Стили

#### `client/src/styles/index.css`
Основные стили приложения:
- **Tailwind CSS**: Подключение утилитарных классов
- **CSS переменные**: Цветовая схема и размеры
- **Компонентные стили**: Стили для сложных компонентов
- **Responsive breakpoints**: Адаптивные точки

#### `client/src/styles/tokens.css`
CSS токены дизайн-системы:
- **Цвета**: Основная палитра, статусы, акценты
- **Типографика**: Размеры шрифтов, межстрочные интервалы
- **Пространства**: Отступы, padding, margin
- **Borders**: Радиусы скругления, толщина границ

### Серверная часть

#### `server/index.ts`
Express сервер для development режима:
- **CORS**: Настройка для cross-origin запросов
- **Static files**: Раздача статических файлов
- **API routes**: Проксирование к внешнему API

#### `netlify/functions/api.ts`
Netlify функция для production:
- **Serverless**: Обработка API запросов в production
- **Proxy**: Перенаправление запросов к внешнему API
- **CORS**: Обработка cross-origin запросов

---

## Ключевые особенности архитектуры

### Кэширование и производительность

**Иерархические фильтры:**
- Кэширование структуры фильтров в localStorage на 24 часа
- Проверка валидности кэша по timestamp
- Fallback загрузка при отсутствии или неактуальности кэша

**React Query:**
- Кэширование запросов каталога на 5 минут (staleTime)
- Сохранение в памяти на 10 минут (gcTime)
- Отключение автоматических refetch для стабильности

### Пользовательский опыт

**Responsive Design:**
- Мобильные фильтры в модальном окне
- Адаптивные сетки карточек (1-4 колонки)
- Оптимизация для touch устройств

**Навигация:**
- Сохранение позиции скролла при переходе на детальную страницу
- Разное поведение ссылок на мобильных (same tab) и десктопе (new tab)
- Синхронизация состояния с URL

**Избранное:**
- Локальное сохранение без регистрации
- Плавающая кнопка для быстрого доступа
- Синхронизация между страницами

### Обработка ошибок

**API Layer:**
- Retry логика с экспоненциальным backoff
- Детальное логирование для диагностики
- Пользовательские сообщения об ошибках
- Timeout обработка (15 секунд)

**UI Layer:**
- Skeleton состояния во время загрузки
- Сообщения об ошибках с кнопками восстановления
- Graceful degradation при недоступности API

---

## Процесс разработки

### Команды для разработки

```bash
# Запуск development сервера
npm run dev

# Сборка клиентской части
npm run build:client

# Сборка серверной части
npm run build:server

# Полная сборка
npm run build

# Запуск production сервера
npm start

# Тесты
npm test

# Форматирование года
npm run format.fix

# Проверка типов
npm run typecheck
```

### Структура commit'ов

Проект использует автоматические git commit'ы для каждого изменения. Для production развертывания используется кнопка Push/Create/PR в интерфейсе.

### Deployment

**Netlify:**
- Автоматическая сборка при push в main
- Netlify Functions для API
- Статические файлы в `/dist/spa`
- Редиректы для SPA роутинга

---

## Интеграция Яндекс Карт

### Места для подключения карт в проекте

**1. Детальная страница автомобиля (`client/src/pages/CarDetailPage.tsx`)**
```typescript
// В секции LocationSection - показать местоположение дилера/салона
const LocationSection: React.FC = () => {
  return (
    <section className="bg-surface rounded-lg lg:rounded-[32px] p-4 lg:p-8">
      <h2 className="text-xl lg:text-2xl font-bold mb-6">Местоположение</h2>
      {/* Здесь добавить Яндекс Карту */}
      <div id="yandex-map" className="w-full h-64 lg:h-96 rounded-lg bg-muted"></div>
    </section>
  );
};
```

**2. Компонент MapPlaceholder (`client/src/components/organisms/MapPlaceholder/`)**
```typescript
// Заменить заглушку на настоящую карту
import { YMaps, Map, Placemark } from '@pbe/react-yandex-maps';

interface MapProps {
  center: [number, number]; // [latitude, longitude]
  zoom?: number;
  dealerLocation?: {
    coordinates: [number, number];
    name: string;
    address: string;
  };
}

export const YandexMap: React.FC<MapProps> = ({
  center,
  zoom = 10,
  dealerLocation
}) => {
  return (
    <YMaps>
      <Map
        defaultState={{ center, zoom }}
        width="100%"
        height="100%"
        className="rounded-lg"
      >
        {dealerLocation && (
          <Placemark
            geometry={dealerLocation.coordinates}
            properties={{
              balloonContent: `
                <strong>${dealerLocation.name}</strong><br/>
                ${dealerLocation.address}
              `
            }}
            options={{
              preset: 'islands#redDotIcon'
            }}
          />
        )}
      </Map>
    </YMaps>
  );
};
```

### Установка и настройка

**1. Установка пакета React Yandex Maps:**
```bash
npm install @pbe/react-yandex-maps
```

**2. Получение API ключа:**
- Перейти на https://developer.tech.yandex.ru/
- Зарегистрироваться и создать приложение
- Получить API ключ для JavaScript API

**3. Настройка провайдера в App.tsx:**
```typescript
import { YMaps } from '@pbe/react-yandex-maps';

// В App.tsx обернуть приложение в YMaps провайдер
<YMaps
  query={{
    apikey: process.env.VITE_YANDEX_MAPS_API_KEY,
    lang: 'ru_RU',
  }}
>
  <QueryClientProvider client={queryClient}>
    <TooltipProvider>
      {/* Остальное приложение */}
    </TooltipProvider>
  </QueryClientProvider>
</YMaps>
```

**4. Переменные окружения (.env):**
```env
VITE_YANDEX_MAPS_API_KEY=ваш_api_ключ_яндекс_карт
```

### Данные для карт

**Координаты для проекта (Приморский край):**
```typescript
// Основные города региона
const COORDINATES = {
  vladivostok: [43.1056, 131.8735],
  nakhodka: [42.8133, 132.8735],
  ussuriysk: [43.7981, 131.9487],
  artem: [43.3603, 132.1887]
};

// Примерные координаты дилерских центров
const DEALER_LOCATIONS = [
  {
    name: "KCL Auto Владивосток",
    address: "г. Владивосток, ул. Калинина, 123",
    coordinates: [43.1056, 131.8735]
  },
  {
    name: "KCL Auto Находка",
    address: "г. Находка, ул. Портовая, 45",
    coordinates: [42.8133, 132.8735]
  }
];
```

**Получение координат из данных автомобиля:**
```typescript
// В carDetailTransforms.ts добавить функцию геокодирования
export function getLocationCoordinates(address: string): Promise<[number, number]> {
  // Использовать Яндекс Геокодер API для получения координат по адресу
  // Или заранее подготовить справочник координат городов
}
```

### Стилизация карты

**CSS для интеграции с дизайн-системой:**
```css
/* В styles/index.css */
.yandex-map-container {
  @apply rounded-lg border border-muted overflow-hidden;
  height: 320px;
}

@media (min-width: 1024px) {
  .yandex-map-container {
    height: 480px;
  }
}

/* Стилизация балунов */
.yandex-balloon {
  @apply bg-surface border border-muted rounded-lg p-4;
}
```

### Примеры использования

**В детальной странице автомобиля:**
```typescript
// CarDetailPage.tsx
const carLocation = getCarLocation(carData); // "Владивосток"
const coordinates = COORDINATES[carLocation.toLowerCase()] || COORDINATES.vladivostok;

<YandexMap
  center={coordinates}
  zoom={12}
  dealerLocation={{
    coordinates,
    name: `KCL Auto ${carLocation}`,
    address: `г. ${carLocation}, автосалон`
  }}
/>
```

**Для страницы контактов (будущее развитие):**
```typescript
// ContactsPage.tsx
<YandexMap
  center={COORDINATES.vladivostok}
  zoom={10}
  dealerLocation={DEALER_LOCATIONS[0]}
/>
```

### Ограничения и рекомендации

- **Лимиты API**: Бесплатно до 25,000 запросов в день
- **Производительность**: Карта загружается асинхронно, показывать skeleton
- **Мобильная версия**: Карта может быть меньше или скрываться на мобильных
- **Fallback**: При ошибке показывать статичное изображение или текстовый адрес
- **Геокодирование**: Не злоупотреблять запросами, использовать кэширование координат

---

## Планы развития

### Возможные улучшения

1. **Авторизация**: Система пользователей для персонализации
2. **Сравнение**: Сравнение характеристик автомобилей
3. **Уведомления**: Push уведомления о новых поступлениях
4. **Яндекс Карты**: Интеграция карт для показа местоположения дилеров (см. раздел выше)
5. **SEO**: Server-side rendering для лучшей индексации
6. **PWA**: Offline функциональность
7. **Тесты**: Unit и integration тесты
8. **A/B тестирование**: Оптимизация конверсии

### Технические долги

1. **Типизация**: Более строгая типизация API ответов
2. **Валидация**: Схемы валидации для форм
3. **Логирование**: Централизованная система логов
4. **Мониторинг**: Метрики производительности
5. **Оптимизация**: Bundle splitting и lazy loading

---

## Технические детали и архитектурные решения

### 1. Связка фронт ↔ бэк

**Backend архитектура:**
- **Production**: Netlify Functions как единственный backend-прокси
- **Development**: Express сервер интегрированный в Vite dev server
- **API URL**: Фиксированный `https://api.tarasov-auto.ru` (хардкод в `client/src/lib/api.ts`)
- **Конфигурация окружений**: НЕ используются environment переменные для API URL
- **CORS**: Настроен на уровне Express сервера (`server/index.ts`), Netlify Functions автоматически обрабатывают CORS

```typescript
// api.ts
const API_BASE_URL = 'https://api.tarasov-auto.ru'; // Фиксированный URL
```

### 2. Каталог и фильтры

**Источник данных фильтров:**
- **Иерархические фильтры**: Приходят ОДНОЙ структурой от API `/filters` целиком
- **Кэширование**: 24 часа в localStorage (`useHierarchicalFilters.ts`)
- **Структура**: `{ [brand]: { [model]: { [generation]: string[] } } }`

**Правила выбора фильтров:**
- **Одиночный выбор**: `brand`, `model`, `generation` (строгое ограничение)
- **Мультивыбор**: `types`, `fuels`, `colors` (массивы)
- **Каскадный сброс**: При изменении родительского фильтра сбрасываются дочерние

**Пагинация и сортировка:**
- **Пагинация**: Серверная (API возвращает `page`, `totalPages`)
- **Сортировка**: Серверная (`date_desc`, `date_asc`, `price_desc`, `price_asc`, `mileage_asc`)

### 3. Детальная страница

**Источники фотографий:**
- **Основной источник**: `ci.encar.com` с обработкой изображений
- **Guaranteed суффиксы**: 001, 003, 004, 007 (приоритетные для каталога)
- **Fallback**: `/placeholder.svg` при отсутствии фото
- **Обработка**: Автоматическое построение URL с параметрами сжатия

```typescript
// photoUtils.ts
const baseUrl = 'https://ci.encar.com';
const imageParams = 'impolicy=heightRate&rh=320&cw=480&ch=320&cg=Center&wtmk=...';
```

**Данные о ДТП:**
- **Формат**: Агрегированные поля `myaccidentcnt` (количество), `myaccidentcost` (стоимость)
- **Расчет**: Готовые данные от API, НЕ считаем на фронте
- **Статус**: `accidentFree = (myaccidentcnt === 0) && (myaccidentcost === 0)`

### 4. Кредитный калькулятор и расчёты

**Логика расчетов:**
- **Модуль**: `client/src/lib/finance.ts`
- **Формула**: Аннуитетный платеж `PMT = PV * r * (1 + r)^n / ((1 + r)^n - 1)`
- **Валидация**: Проверка корректности входных данных

**Курсы валют:**
- **Источник**: Статические данные в `PriceCalculationPopover.tsx` (НЕ из API)
- **Ручной override**: НЕ предусмотрен в UI
- **Данные курсов**: Хардкод значений (RUB/KRW: 17.22, EUR/RUB: 93.37, etc.)

**Сохранение значений:**
- **localStorage**: НЕ используется для калькулятора
- **URL**: НЕ сохраняется в URL параметрах
- **Состояние**: Локальное состояние компонента (сбрасывается при перезагрузке)

### 5. Избранное и состояние

**Хранение избранного:**
- **Только localStorage**: Без авторизации и синхронизации с сервером
- **Формат**: Массив ID автомобилей + полные объекты Car
- **Синхронизация**: Между компонентами через `useFavorites` хук

**UI для избранного:**
- **Отдельная страница**: НЕ реализована (нет маршрута `/favorites`)
- **Доступ**: Через `FloatingFavoritesButton` - поповер с списком

### 6. Формы и отправка заявок

**InterestSection (форма обратной связи):**
- **Назначение**: Сбор контактов потенциальных клиентов
- **API endpoint**: НЕ реализован (заглушка с `console.log`)
- **Текущая логика**: Валидация + лог в консоль

```typescript
// CarDetailPage.tsx - InterestSection
const handleSubmit = () => {
  if (!phone || !agreed) {
    alert('Заполните все поля и согласитесь с условиями');
    return;
  }
  console.log('Form submitted:', { phone, agreed }); // TODO: отправка на сервер
};
```

**Защита от спама:**
- **Капча**: НЕ реализована
- **Маски телефона**: Базовая валидация в `utils.ts`
- **Валидация страны**: НЕ реализована

### 7. Ошибки и retry стратегии

**Текущая backoff логика:**
- **Стратегия**: Экспоненциальный backoff `Math.pow(2, retryCount) * 1000`
- **Максимум retry**: 3 попытки
- **Timeout**: 15 секунд
- **429 (Rate Limit)**: Обрабатывается как server error (retry)
- **5xx errors**: Автоматический retry

**Пользовательские уведомления:**
- **Централизованные**: НЕ реализованы
- **Timeout CTA**: НЕ реализован
- **Текущий подход**: Локальные error states в компонентах

### 8. SEO/индексация

**Текущее состояние:**
- **Архитектура**: Чистая SPA (Single Page Application)
- **SSR/SSG планы**: НЕ запланированы (остается на SPA)
- **Пререндер**: Возможен через Netlify (НЕ настроен)

**Meta-теги для детальных страниц:**
- **H1**: `<h1>{car.name}</h1>` - критично УЖЕ реализовано
- **Meta title**: НЕ генерируется из данных авто
- **Meta description**: НЕ генерируется из данных авто
- **Open Graph**: НЕ реализован

### 9. Деплой и конфиги

**Окружения:**
- **Разделение env**: НЕ реализовано четкое разделение prod/staging/dev
- **Переменные**: Используется только `process.env.PING_MESSAGE` в server demo
- **API URLs**: Хардкод без переключения по окружениям

**Ограничения бандла:**
- **Code splitting**: НЕ реализован
- **Lazy loading**: НЕ реализован для фото/секций
- **Bundle size**: БЕЗ мониторинга и ограничений
- **Оптимизация**: Базовая сборка Vite без дополнительных настроек

**Рекомендации для production:**

1. **Environment Variables**: Настроить `VITE_API_BASE_URL` для разных окружений
2. **Error Handling**: Централизованная система уведомлений (Toast/Notification)
3. **Code Splitting**: React.lazy для страниц и тяжелых компонентов
4. **SEO**: Добавить meta-теги из данных автомобилей
5. **Forms**: Реализовать backend для обработки заявок
6. **Monitoring**: Bundle analyzer и performance метрики
7. **Caching**: Настроить HTTP кэширование для статических ресурсов

---

Эта документация покрывает все основные аспекты проекта и должна помочь любому разработчику быстро разобраться в архитектуре и начать эффективную работу с кодом.
